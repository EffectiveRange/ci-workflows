# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

# GitHub recommends pinning actions to a commit SHA.
# To get a newer version, you will need to update the SHA.
# You can also reference a tag or branch, but the action may change without warning.

name: CI/CD

on:
  workflow_call:
    inputs:
      test-enabled:
        required: false
        type: boolean
        description: 'Should run tests?'
        default: true
      test-architecture:
        required: false
        type: string
        default: 'amd64'
        description: 'Architecture to use for running tests'
      test-distribution:
        required: false
        type: string
        default: 'bookworm'
        description: 'Distribution to use for running tests'
      test-timeout:
        required: false
        type: number
        description: 'Test timeout in seconds'
        default: 10
      coverage-enabled:
        required: false
        type: boolean
        description: 'Should run with coverage?'
        default: true
      coverage-threshold:
        required: false
        type: number
        description: 'Minimum coverage threshold'
        default: 80
      package-architecture:
        required: false
        type: string
        default: '["armhf", "arm64", "amd64"]'
        description: 'Architecture to run builds on (must be valid JSON array format)'
      package-distribution:
        required: false
        type: string
        default: '["bullseye", "bookworm"]'
        description: 'Distribution to run builds on (must be valid JSON array format)'
      package-type:
        required: false
        type: string
        default: '["wheel", "fpm-deb"]'
        description: 'Packaging type (must be valid JSON array format)'
      secrets:
        access-token:
          required: false

concurrency:
  group: ${{ github.workflow }}-${{ github.sha }}
  cancel-in-progress: true

env:
  GITHUB_TOKEN: ${{ secrets.access-token || github.token }}
  GITHUB_ACTION: "TRUE"

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest
    if: ${{ inputs.test-enabled }}
    permissions:
      contents: write
      discussions: write

    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ env.GITHUB_TOKEN }}

      - name: Set up QEMU for multi-architecture builds
        uses: docker/setup-qemu-action@v3

      - name: Build and test
        uses: devcontainers/ci@v0.3
        with:
          subFolder: "${{ github.workspace }}"
          configFile: .devcontainer/${{ inputs.test-architecture }}-${{ inputs.test-distribution }}-container/devcontainer.json
          push: never
          runCmd: |
            pip install mypy flake8 pytest pytest-timeout
            pip install .
            mypy --install-types --non-interactive || true && mypy
            flake8
            if [ ${{ inputs.coverage-enabled }} == true ]; then
              pip install coverage
              coverage run -m pytest --timeout=${{ inputs.test-timeout }}
            else
              pytest --timeout=${{ inputs.test-timeout }}
            fi

      - if: ${{ inputs.coverage-enabled && github.event_name == 'pull_request' }}
        name: Coverage comment
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ env.GITHUB_TOKEN }}

      - if: ${{ inputs.coverage-enabled }}
        name: Enforce minimum coverage
        id: coverage-gate
        run: |
          pip install coverage
          coverage report --show-missing --fail-under=${{ inputs.coverage-threshold }}

  prepare:
    name: Prepare release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      discussions: write
    outputs:
      version: ${{ steps.set-version.outputs.version }}
    steps:
      - name: Extract version
        id: set-version
        run: |
          VERSION_REGEX="^[0-9]+\.[0-9]+\.[0-9]+$"
          if [[ "${GITHUB_REF#refs/tags/v}" =~ $VERSION_REGEX ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "Error: Invalid version tag ${GITHUB_REF#refs/tags/}"
            exit 1
          fi

  build_wheel:
    if: contains('${{ inputs.package-type }}', 'wheel')
    name: Create wheel package
    runs-on: ubuntu-latest
    needs: prepare
    permissions:
      contents: write
      discussions: write
    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ env.GITHUB_TOKEN }}

      - name: Update version in setup.py
        run: |
          if [ -f setup.py ]; then
            sed -i "s/version=['\"].*['\"]/version='${{ needs.prepare.outputs.version }}'/" setup.py
          else
            echo "setup.py not found"
            exit 1
          fi

      - name: Create package
        uses: devcontainers/ci@v0.3
        with:
          subFolder: "${{ github.workspace }}"
          configFile: .devcontainer/amd64-bookworm-container/devcontainer.json
          push: never
          runCmd: pack_python . -s wheel

      - name: Upload package
        uses: actions/upload-artifact@v4
        if: ${{ !startsWith(github.ref, 'refs/pull/') }}
        with:
          name: ${{ github.event.repository.name }}
          path: dist/*.whl
          if-no-files-found: error

  build_fpm-deb:
    if: contains('${{ inputs.package-type }}', 'fpm-deb')
    name: Create debian package with FPM
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      matrix:
        distribution: ${{ fromJson(inputs.package-distribution) }}
    permissions:
      contents: write
      discussions: write
    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ env.GITHUB_TOKEN }}

      - name: Update version in setup.py
        run: |
          if [ -f setup.py ]; then
            sed -i "s/version=['\"].*['\"]/version='${{ needs.prepare.outputs.version }}'/" setup.py
          else
            echo "setup.py not found"
            exit 1
          fi

      - name: Create package
        uses: devcontainers/ci@v0.3
        with:
          subFolder: "${{ github.workspace }}"
          configFile: .devcontainer/amd64-${{ matrix.distribution }}-container/devcontainer.json
          push: never
          runCmd: |
            pack_python . -s fpm-deb
            DISTRIBUTION="$(echo ${{ matrix.distribution }} | cut -d'-' -f2)_"
            for package in $(find dist -name *.deb)
            do
              mv -vf $package $(dirname $pkg)/${DISTRIBUTION}_$(basename $package)
            done

      - name: Upload package
        uses: actions/upload-artifact@v4
        if: ${{ !startsWith(github.ref, 'refs/pull/') }}
        with:
          name: ${{ github.event.repository.name }}
          path: dist/*.deb
          if-no-files-found: error

  build_dh-virtualenv:
    if: contains('${{ inputs.package-type }}', 'dh-virtualenv')
    name: Create debian package with dh-virtualenv
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      matrix:
        architecture: ${{ fromJson(inputs.package-architecture) }}
        distribution: ${{ fromJson(inputs.package-distribution) }}
    permissions:
      contents: write
      discussions: write
    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ env.GITHUB_TOKEN }}

      - name: Set up QEMU for multi-architecture builds
        uses: docker/setup-qemu-action@v3

      - name: Update version in setup.py
        run: |
          if [ -f setup.py ]; then
            sed -i "s/version=['\"].*['\"]/version='${{ needs.prepare.outputs.version }}'/" setup.py
          else
            echo "setup.py not found"
            exit 1
          fi

      - name: Create package
        uses: devcontainers/ci@v0.3
        with:
          subFolder: "${{ github.workspace }}"
          configFile: .devcontainer/${{ matrix.architecture }}-${{ matrix.distribution }}-container/devcontainer.json
          push: never
          runCmd: |
            pack_python . -s dh-virtualenv
            DISTRIBUTION="$(echo ${{ matrix.distribution }} | cut -d'-' -f2)_"
            for package in $(find dist -name *.deb)
            do
              mv -vf $package $(dirname $pkg)/${DISTRIBUTION}_$(basename $package)
            done

      - name: Upload package
        uses: actions/upload-artifact@v4
        if: ${{ !startsWith(github.ref, 'refs/pull/') }}
        with:
          name: ${{ github.event.repository.name }}
          path: dist/*.deb
          if-no-files-found: error

  release:
    name: Create release
    runs-on: ubuntu-latest
    needs: prepare
    permissions:
      contents: write
      discussions: write
    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ env.GITHUB_TOKEN }}

      - name: Update version in setup.py
        run: |
          if [ -f setup.py ]; then
            sed -i "s/version=['\"].*['\"]/version='${{ needs.prepare.outputs.version }}'/" setup.py
          else
            echo "setup.py not found"
            exit 1
          fi

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git diff --exit-code || git commit -am "Update version to ${{ needs.prepare.outputs.version }}"

      - name: Push changes
        uses: ad-m/github-push-action@master
        if: ${{ !startsWith(github.ref, 'refs/pull/') && success() }}
        with:
          github_token: ${{ env.GITHUB_TOKEN }}

      - name: Create release
        uses: EffectiveRange/version-release-github-action@v1
