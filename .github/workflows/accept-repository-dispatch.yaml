name: Prepare Release

on:
  workflow_call:
    inputs:
      main_branch:
        description: "Branch to treat as main for tag bumping"
        required: false
        type: string
        default: "main"

      versioned_dispatch_type:
        description: "repository_dispatch action string that should use client_payload.version"
        required: true
        type: string

    outputs:
      tag:
        description: "Release tag (vX.Y.Z)"
        value: ${{ jobs.prepare.outputs.tag }}
      version:
        description: "Release version (X.Y.Z)"
        value: ${{ jobs.prepare.outputs.version }}
      base_version:
        description: "Base image version to use (payload version or latest)"
        value: ${{ jobs.prepare.outputs.base_version }}
      dispatch_type:
        description: "repository_dispatch action (empty for tag push)"
        value: ${{ jobs.prepare.outputs.dispatch_type }}
      payload_version:
        description: "Source version from the payload that triggered this workflow"
        value: ${{ jobs.prepare.outputs.payload_version }}

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    permissions:
      contents: write
    concurrency:
      group: tagging-${{ github.repository }}-${{ inputs.main_branch }}
      cancel-in-progress: false
    outputs:
      tag: ${{ steps.out.outputs.tag }}
      version: ${{ steps.out.outputs.version }}
      base_version: ${{ steps.out.outputs.base_version }}
      dispatch_type: ${{ steps.out.outputs.dispatch_type }}
      payload_version: ${{ steps.out.outputs.payload_version }}

    steps:
      - name: Checkout (full history + tags)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Compute vars (and optionally create+push tag)
        id: out
        shell: bash
        env:
          MAIN_BRANCH: ${{ inputs.main_branch }}
          VERSIONED_TYPE: ${{ inputs.versioned_dispatch_type }}
        run: |
          set -euo pipefail

          EVENT="${GITHUB_EVENT_NAME}"
          dispatch_type=""
          base_version="latest"
          payload_version="latest"

          if [[ "$EVENT" == "repository_dispatch" ]]; then
            dispatch_type="$(jq -r .action "$GITHUB_EVENT_PATH")"
            payload_version="$(jq -r '.client_payload.version // empty' "$GITHUB_EVENT_PATH")"
            if [[ -z "${payload_version//[[:space:]]/}" ]]; then
              echo "Error: ${dispatch_type} requires client_payload.version" >&2
              exit 1
            fi
            if [[ "$dispatch_type" == "$VERSIONED_TYPE" ]]; then
              base_version="$payload_version"
            else
              base_version="latest"
            fi

            # Ensure origin/<main_branch> is present and up to date
            git fetch --force --tags origin "refs/heads/${MAIN_BRANCH}:refs/remotes/origin/${MAIN_BRANCH}"

            latest_tag="$(git tag --merged "origin/${MAIN_BRANCH}" \
              --list 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n 1)"

            if [[ -z "${latest_tag}" ]]; then
              echo "Error: No vX.Y.Z tags found on origin/${MAIN_BRANCH} to bump." >&2
              exit 1
            fi

            IFS='.' read -r major minor patch <<< "${latest_tag#v}"
            new_patch=$((patch + 1))
            tag="v${major}.${minor}.${new_patch}"

            echo "Dispatch type:         ${dispatch_type}"
            echo "Latest tag on ${MAIN_BRANCH}: ${latest_tag}"
            echo "New tag to create:     ${tag}"
            echo "Base image version:    ${base_version}"
            echo "Payload version:       ${payload_version}"

            # Ensure we're on main HEAD
            git checkout -B "${MAIN_BRANCH}" "origin/${MAIN_BRANCH}"

            # HARD FAIL if computed tag already exists on origin (no reuse)
            if git ls-remote --tags origin "${tag}" | grep -q "${tag}$"; then
              echo "Error: tag ${tag} already exists on origin. Refusing to reuse." >&2
              exit 1
            fi
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git tag -a "${tag}" -m "Automated patch release ${tag} (${dispatch_type})"
            git push origin "refs/tags/${tag}"

          else
            # push tag event
            tag="${GITHUB_REF#refs/tags/}"
            base_version="latest"
            echo "Triggered by tag push: ${tag}"
          fi

          version="${tag#v}"

          echo "dispatch_type=${dispatch_type}" >> "$GITHUB_OUTPUT"
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "base_version=${base_version}" >> "$GITHUB_OUTPUT"
          echo "payload_version=${payload_version}" >> "$GITHUB_OUTPUT"
